pipeline {
    agent any

    environment {
        ENV_PATH = 'injected.env'
        RECIPIENTS = 'aurelien.chalm@gmail.com'
    }

    stages {
        stage('Pr√©parer le .env') {
            steps {
                withCredentials([file(credentialsId: 'env_file', variable: 'REAL_ENV')]) {
                    script {
                        sh "rm -f $WORKSPACE/$ENV_PATH"
                        def envContent = readFile("${REAL_ENV}")
                        writeFile file: "$WORKSPACE/$ENV_PATH", text: envContent
                    }
                }
            }
        }

        stage('Construire l‚Äôimage de test') {
            steps {
                script {
                    docker.build('housing-prices-prediction', '-f test/Dockerfile.load_to_db .')
                }
            }
        }

        stage('Ex√©cuter les tests') {
            steps {
                script {
                    docker.image('housing-prices-prediction').inside("--env-file $WORKSPACE/$ENV_PATH --user 1000") {
                    sh 'pytest test/test_train.py --junitxml=test-reports/unit-tests.xml'
                    }
                }
            }
        }

        stage('Ex√©cuter load_to_db.py') {
            steps {
                script {
                    docker.image('housing-prices-prediction').inside("--env-file $WORKSPACE/$ENV_PATH") {
                        sh 'python src/load_to_db.py'
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'üì¶ Pipeline termin√©.'
            junit 'test-reports/unit-tests.xml'
            
        }
        failure {
            echo '‚ùå Le pipeline a √©chou√©.'
            emailext subject: "‚ùå FAILURE: Job ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            body: """
Bonjour coll√®gue,

Le job ${env.JOB_NAME} a √©chou√© au build #${env.BUILD_NUMBER}.

üîó Voir les logs : ${env.BUILD_URL}console

Il est temps d‚Äôinvestiguer !

-- 
Ton Jenkins pr√©f√©r√©
""",
            to: "${env.RECIPIENTS}",
            from: "aurelien.chalm@gmail.com"
        }
        success {
            echo '‚úÖ Le pipeline a r√©ussi.'
            emailext subject: "‚úÖ SUCCESS: Job ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            body: """
Bonjour coll√®gue,

Le job ${env.JOB_NAME} a r√©ussi avec le build #${env.BUILD_NUMBER}.

üîó Voir les logs : ${env.BUILD_URL}console

Bien √† toi,
Ton Jenkins pr√©f√©r√©
""",
            to: "${env.RECIPIENTS}",
            from: "aurelien.chalm@gmail.com"
        }
    }
}